import _ from"http";import A from"querystring";var h=(s,e,...r)=>{let{level:n,color:a}=s;if(e&&e.exception){console.log("ERROR: ",e.exception);return}["system","error","warn","info","debug"].indexOf(n)<(process.env.LOG_LEVEL||0)&&console.log(...r)},p=h;var T=(s,e,{onlyHeaders:r=!1,status:n,contentType:a,contentSize:t,data:o,error:i})=>{e.setHeader("Access-Control-Allow-Origin",s.headers.origin||"http://localhost:4000"),e.setHeader("Access-Control-Allow-Methods","GET, POST, PATCH, OPTIONS, DELETE"),e.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization, X-API-KEY"),e.setHeader("Access-Control-Allow-Credentials",!0);var c={"Content-Type":a||"application/json"};return t&&(c["Content-Length"]=t),e.writeHead(n||200,c),r||e.write(JSON.stringify({data:o,error:i,serverTime:new Date})),e.end()},d={sendResponseWithHeaders:T,guid(s){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}if(s==8)return e()+e();switch(s){case 4:return e();case 8:return e()+e();case 12:return e()+e()+e()}return e()+e()+e()+e()+e()+e()+new Date().getTime().toString(16)},async getRequestPayload(s,e=!1){return new Promise((r,n)=>{let a=[];s.on("data",t=>{a.push(t)}),s.on("end",()=>{let o=Buffer.concat(a).toString();if(e)r(o);else try{r(JSON.parse(o))}catch{r()}}),s.on("error",()=>{r()})})}};var f={HTTP_REQUEST_ERROR:{code:"HTTP_REQUEST_ERROR",message:"Http request error with exception"},PAYLOAD_ERROR:{code:"PAYLOAD_ERROR",message:"Payload error"},DB_CONNECTION_ERROR:{code:"DB_CONNECTION_ERROR",message:"DB disconnected"},ACTION_METHOD_NOT_FOUND:{code:"ACTION_METHOD_NOT_FOUND",message:"Action method not found"},ACTION_NOT_FOUND:{code:"ACTION_NOT_FOUND",message:"Endpoint action not found"},NOT_IMPLEMENTED_ERROR:{code:"NOT_IMPLEMENTED_ERROR",message:"Not implemented error"},INVALID_ACCESS:{code:"INVALID_ACCESS",message:"Invalid access to this request"}};var l={},{guid:y}=d,g={async addItems(s,e){l[e]||(l[e]=[]);let r=[],n=[];return s.forEach(a=>{a._id?r.push(a):n.push({...a,_id:y(),createdAt:new Date})}),r.length&&l[e].forEach(a=>{let t=r.find(o=>o._id===a._id);t&&(Object.keys(t.fieldsToUpdate).forEach(o=>{a[o]=t.fieldsToUpdate[o]}),a.updatedAt=new Date)}),l[e]=l[e].concat(n),{items:l[e]||[],error:null}},async getItems(s,e){return{items:l[e]||[],error:null}},async deleteItems(s,e){return l[e]=l[e].filter(r=>!s.map(n=>n._id).includes(r._id)),{items:l[e]||[],error:null}}};var R={name:"tablename",async filter(s){let{req:e,res:r,dbManager:n,collectionName:a}=s,t=await d.getRequestPayload(e);if(!t)return d.sendResponseWithHeaders(e,r,{status:200,data:[]});let{find:o,options:i}=t,c=await n.getItems({find:o,options:i},a);return d.sendResponseWithHeaders(e,r,{status:200,data:c||[]})},async get(s){let{req:e,res:r,dbManager:n,collectionName:a}=s,t=await n.getItems({},a);return d.sendResponseWithHeaders(e,r,{status:200,data:t.items||[],error:t.error})},async post(s){let{req:e,res:r,dbManager:n,collectionName:a}=s,t=await d.getRequestPayload(e);if(!t)return d.sendResponseWithHeaders(e,r,{status:200,data:[]});let{items:o}=t;if(o&&o.length>0){let i=await n.addItems(o,a);return d.sendResponseWithHeaders(e,r,{status:200,data:i.items||[],error:i.error})}return d.sendResponseWithHeaders(e,r,{status:200,data:[]})},async delete(s){let{req:e,res:r,dbManager:n,collectionName:a}=s,t=await d.getRequestPayload(e);if(!t)return d.sendResponseWithHeaders(e,r,{status:200,data:[]});let{items:o}=t;if(o&&o.length>0){let i=await n.deleteItems(o,a);return d.sendResponseWithHeaders(e,r,{status:200,data:i.items||[],error:i.error})}return d.sendResponseWithHeaders(e,r,{status:200,data:[]})}};var{sendResponseWithHeaders:E,getRequestPayload:q,guid:F}=d;function C(){let s=["InMemory","LocalFiles","MongoDB"],e={port:4002,exceptionCallback:t=>{console.log("Exception occured: ",t)},storageType:"InMemory",dbManager:g};function r(){p({level:"debug"},{},"App initiated")}let n=new r,a=async(t,o)=>{p({level:"info"},{},`Request received for ${t.url}`);let i=t.method.toLowerCase();if(i=="options")return E(t,o,{onlyHeaders:!0});let c=A.parse(t.url.split("?")[1]),I=c.skipAuth==="true",u=c.tablename;if(u){let m=R[i];if(m){let O={req:t,res:o,dbManager:e.dbManager,collectionName:u};return m(O)}}return E(t,o,{error:f.NOT_IMPLEMENTED_ERROR})};return r.prototype.catch=t=>{e.exceptionCallback=t||e.exceptionCallback},r.prototype.port=t=>(e.port=t,n),r.prototype.use=(t={storageType:"InMemory",dbManager})=>(e=Object.assign({},e,t),n),r.prototype.start=(t=()=>{},o)=>{e.exceptionCallback=o||e.exceptionCallback;try{_.createServer(a).listen(e.port,i=>{p({level:"debug"},{},`Http server started at *:${e.port}`),t(e.port)}).on("error",i=>{p({},{exception:i},"Exception error"),e.exceptionCallback(i)})}catch(i){p({},{exception:i},"Exception error"),e.exceptionCallback(i)}return n},n}var B=C();export{B as default};
