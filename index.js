import b from"http";import D from"querystring";var C=(n,e,...a)=>{let{level:o,color:s}=n;if(e&&e.exception){console.log("ERROR: ",e.exception);return}["system","error","warn","info","debug"].indexOf(o)<(process.env.LOG_LEVEL||0)&&console.log(...a)},T=C;var S=(n,e,{onlyHeaders:a=!1,status:o,contentType:s,contentSize:t,data:r,error:i})=>{e.setHeader("Access-Control-Allow-Origin",n.headers.origin||"http://localhost:4000"),e.setHeader("Access-Control-Allow-Methods","GET, POST, PATCH, OPTIONS, DELETE"),e.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization, X-API-KEY"),e.setHeader("Access-Control-Allow-Credentials",!0);var f={"Content-Type":s||"application/json"};return t&&(f["Content-Length"]=t),e.writeHead(o||200,f),a||e.write(JSON.stringify({data:r,error:i,serverTime:new Date})),e.end()},l={sendResponseWithHeaders:S,guid(n){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}if(n==8)return e()+e();switch(n){case 4:return e();case 8:return e()+e();case 12:return e()+e()+e()}return e()+e()+e()+e()+e()+e()+new Date().getTime().toString(16)},async getRequestPayload(n,e=!1){return new Promise((a,o)=>{let s=[];n.on("data",t=>{s.push(t)}),n.on("end",()=>{let r=Buffer.concat(s).toString();if(e)a(r);else try{a(JSON.parse(r))}catch{a()}}),n.on("error",()=>{a()})})}};var m={HTTP_REQUEST_ERROR:{code:"HTTP_REQUEST_ERROR",message:"Http request error with exception"},PAYLOAD_ERROR:{code:"PAYLOAD_ERROR",message:"Payload error"},DB_CONNECTION_ERROR:{code:"DB_CONNECTION_ERROR",message:"DB disconnected"},ACTION_METHOD_NOT_FOUND:{code:"ACTION_METHOD_NOT_FOUND",message:"Action method not found"},ACTION_NOT_FOUND:{code:"ACTION_NOT_FOUND",message:"Endpoint action not found"},NOT_IMPLEMENTED_ERROR:{code:"NOT_IMPLEMENTED_ERROR",message:"Not implemented error"},INVALID_ACCESS:{code:"INVALID_ACCESS",message:"Invalid access to this request"},MISSING_USER_TABLE_NAME:{code:"MISSING_USER_TABLE_NAME",message:"Missing user table name"},USERNAME_ALREADY_EXISTS:{code:"USERNAME_ALREADY_EXISTS",message:"Username already exists"},INVALID_CREDENTIALS:{code:"INVALID_CREDENTIALS",message:"Invalid credentials"}};var R={},{guid:M}=l,I={async addItems(n,e){R[e]||(R[e]=[]);let a=[],o=[];return n.forEach(s=>{s._id?a.push(s):o.push({...s,_id:M(),createdAt:new Date})}),a.length&&R[e].forEach(s=>{let t=a.find(r=>r._id===s._id);t&&(Object.keys(t.fieldsToUpdate).forEach(r=>{s[r]=t.fieldsToUpdate[r]}),s.updatedAt=new Date)}),R[e]=R[e].concat(o),{items:R[e]||[],error:null}},async getItems(n,e){return{items:R[e]||[],error:null}},async deleteItems(n,e){return R[e]=R[e].filter(a=>!n.map(o=>o._id).includes(a._id)),{items:R[e]||[],error:null}}};var N={name:"tablename",async filter(n){let{req:e,res:a,dbManager:o,collectionName:s}=n,t=await l.getRequestPayload(e);if(!t)return l.sendResponseWithHeaders(e,a,{status:200,data:[]});let{find:r,options:i}=t,f=await o.getItems({find:r,options:i},s);return l.sendResponseWithHeaders(e,a,{status:200,data:f||[]})},async get(n){let{req:e,res:a,dbManager:o,collectionName:s}=n,t=await o.getItems({},s);return l.sendResponseWithHeaders(e,a,{status:200,data:t.items||[],error:t.error})},async post(n){let{req:e,res:a,dbManager:o,collectionName:s}=n,t=await l.getRequestPayload(e);if(!t)return l.sendResponseWithHeaders(e,a,{status:200,data:[]});let{items:r}=t;if(r&&r.length>0){let i=await o.addItems(r,s);return l.sendResponseWithHeaders(e,a,{status:200,data:i.items||[],error:i.error})}return l.sendResponseWithHeaders(e,a,{status:200,data:[]})},async delete(n){let{req:e,res:a,dbManager:o,collectionName:s}=n,t=await l.getRequestPayload(e);if(!t)return l.sendResponseWithHeaders(e,a,{status:200,data:[]});let{items:r}=t;if(r&&r.length>0){let i=await o.deleteItems(r,s);return l.sendResponseWithHeaders(e,a,{status:200,data:i.items||[],error:i.error})}return l.sendResponseWithHeaders(e,a,{status:200,data:[]})}};var{sendResponseWithHeaders:c,getRequestPayload:y,guid:J}=l;function w(){let n=["InMemory","LocalFiles","MongoDB"],e={port:4002,exceptionCallback:t=>{console.log("Exception occured: ",t)},storageType:"InMemory",dbManager:I,authentication:null};function a(){T({level:"debug"},{},"App initiated")}let o=new a,s=async(t,r)=>{T({level:"info"},{},`Request received for ${t.url}`);let i=t.method.toLowerCase();if(i=="options")return c(t,r,{onlyHeaders:!0});let f=D.parse(t.url.split("?")[1]),O=f.skipAuth==="true",_=!0;if(e.authentication){if(_=!1,f.action=="authenticate"){if(!e.authentication.userTableName)return c(t,r,{error:m.MISSING_USER_TABLE_NAME});let u=await y(t),d=await e.dbManager.getItems({},e.authentication.userTableName);if(d&&d.items&&d.items.length>0){let g=d.items.find(p=>p.username===u.username&&p.password===u.password);if(g){let p={...g};delete p.password;let E=null;return e.authentication.encryptTokenCallback?E=await e.authentication.encryptTokenCallback(p):E=JSON.stringify({username:p.username,role:p.role}),c(t,r,{data:{isValid:!0,token:E}})}else return c(t,r,{error:m.INVALID_CREDENTIALS})}return c(t,r,{error:o?.error||m.DB_CONNECTION_ERROR})}if(f.action=="register"){if(!e.authentication.userTableName)return c(t,r,{error:m.MISSING_USER_TABLE_NAME});let u=await y(t),d=await e.dbManager.getItems({},e.authentication.userTableName);if(d&&d.items&&d.items.length>0&&d.items.find(p=>p.username===u.username))return c(t,r,{error:m.USERNAME_ALREADY_EXISTS});let g=await e.dbManager.addItems([u],e.authentication.userTableName);if(g&&g.items){let p=g.items.find(E=>E.username===u.username);if(p){let E={...p};delete E.password;let h=null;return e.authentication.encryptTokenCallback?h=await e.authentication.encryptTokenCallback(E):h=JSON.stringify({username:E.username,role:E.role}),c(t,r,{data:{isValid:!0,token:h}})}}return c(t,r,{error:o?.error||m.DB_CONNECTION_ERROR})}if(O)_=!0;else{if(!t.headers.authorization)return c(t,r,{error:m.INVALID_ACCESS});let u=t.headers.authorization.replace("Bearer ","");if(!(u&&u.length>0))return c(t,r,{error:m.INVALID_ACCESS});if(e.authentication.decryptTokenCallback){let d=await e.authentication.decryptTokenCallback(u);d&&(t.user=d,_=!0)}}}if(!_)return c(t,r,{error:m.INVALID_ACCESS});if(f.action=="tokeninfo")return c(t,r,{data:t.user});let A=f.tablename;if(A){let u=N[i];if(u){let d={req:t,res:r,dbManager:e.dbManager,collectionName:A};return u(d)}}return c(t,r,{error:m.NOT_IMPLEMENTED_ERROR})};return a.prototype.catch=t=>{e.exceptionCallback=t||e.exceptionCallback},a.prototype.port=t=>(e.port=t,o),a.prototype.use=(t={storageType:"InMemory",dbManager})=>(e=Object.assign({},e,t),o),a.prototype.start=(t=()=>{},r)=>{e.exceptionCallback=r||e.exceptionCallback;try{b.createServer(s).listen(e.port,i=>{T({level:"debug"},{},`Http server started at *:${e.port}`),t(e.port)}).on("error",i=>{T({},{exception:i},"Exception error"),e.exceptionCallback(i)})}catch(i){T({},{exception:i},"Exception error"),e.exceptionCallback(i)}return o},o}var X=w();export{X as default};
